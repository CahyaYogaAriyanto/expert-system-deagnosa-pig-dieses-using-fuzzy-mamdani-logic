<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Live Chat User</title>
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 h-screen flex">
  <!-- Sidebar Pakar -->
  <div class="w-1/3 bg-white shadow-lg flex flex-col">
    <div class="p-4 border-b">
      <h2 class="text-lg font-semibold">Daftar Pakar</h2>
    </div>
    <div id="pakar-list" class="flex-1 overflow-y-auto"></div>
  </div>

  <!-- Chat Area -->
  <div class="flex-1 flex flex-col bg-white shadow-lg ml-2 rounded-lg">
    <!-- Header -->
    <div class="p-4 border-b bg-blue-600 text-white rounded-t-lg">
      <h2 class="text-lg font-semibold">Chat dengan <span id="chat-with">-</span></h2>
      <p class="text-sm">User: <span id="user-name">{{ username }}</span></p>
    </div>

    <!-- Chat box -->
    <div id="chat-box" class="flex-1 p-4 overflow-y-auto space-y-2 bg-gray-50"></div>

    <!-- Input pesan -->
    <div class="p-4 border-t flex gap-2">
      <input id="message" type="text" placeholder="Tulis pesan..."
             class="flex-1 border rounded-lg px-3 py-2 focus:outline-none focus:ring focus:ring-blue-200">
      <button id="send" class="bg-blue-600 text-white px-4 py-2 rounded-lg">Kirim</button>
    </div>
  </div>

  <script>
    const username = "{{ username }}";
    let currentPakar = null;
    const socket = io();

    socket.emit("join", { username });

    const chatBox = document.getElementById("chat-box");
    const sendBtn = document.getElementById("send");
    const msgInput = document.getElementById("message");
    const chatWithEl = document.getElementById("chat-with");

    // Ambil daftar pakar
    fetch("/pakar_list")
      .then(res => res.json())
      .then(data => {
        const list = document.getElementById("pakar-list");
        data.forEach(pakar => {
          const item = document.createElement("div");
          item.className = "p-4 border-b hover:bg-gray-100 cursor-pointer";
          item.innerHTML = `<div class="font-semibold">${pakar.nama}</div>
                            <div class="text-sm text-gray-500">${pakar.spesialisasi || ''}</div>`;
          item.addEventListener("click", () => {
            currentPakar = pakar.nama;
            chatWithEl.textContent = pakar.nama;
            loadHistory(pakar.nama);
          });
          list.appendChild(item);
        });
      });

    // Load history chat
    function loadHistory(pakar) {
      fetch(`/chat_history/${pakar}`)
        .then(res => res.json())
        .then(chats => {
          chatBox.innerHTML = "";
          chats.forEach(c => {
            if (c.sender === username) {
              chatBox.innerHTML += `<div class="text-right">
                <span class="inline-block bg-blue-500 text-white px-3 py-1 rounded-lg">${c.message}</span>
              </div>`;
            } else {
              chatBox.innerHTML += `<div class="text-left">
                <span class="inline-block bg-gray-300 px-3 py-1 rounded-lg"><b>${c.sender}:</b> ${c.message}</span>
              </div>`;
            }
          });
          chatBox.scrollTop = chatBox.scrollHeight;
        });
    }

    // Kirim pesan
    sendBtn.addEventListener("click", () => {
      const message = msgInput.value.trim();
      if (!message || !currentPakar) {
        alert("Pilih pakar dan isi pesan!");
        return;
      }
      socket.emit("user_message", { sender: username, receiver: currentPakar, message });
      msgInput.value = "";
    });

    // Terima pesan
    socket.on("user_receive", data => {
      if (data.pakar === username) return; // skip pesan echo
      chatBox.innerHTML += `<div class="text-left">
        <span class="inline-block bg-gray-300 px-3 py-1 rounded-lg"><b>${data.pakar}:</b> ${data.message}</span>
      </div>`;
      chatBox.scrollTop = chatBox.scrollHeight;
    });
  </script>
</body>
</html>
